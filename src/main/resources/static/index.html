<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Agent IA - Chat Multimodal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background-color: #0056d2;
            color: white;
            text-align: center;
            padding: 1rem;
            font-size: 1.75rem;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            letter-spacing: 1px;
        }

        .chat-container {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: fadeIn 0.3s ease;
        }

        .message {
            padding: 14px 18px;
            border-radius: 16px;
            max-width: 75%;
            line-height: 1.6;
            background: #e4e6eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            word-wrap: break-word;
            font-size: 15px;
        }

        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.ai {
            background: #f1f3f5;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.1);
        }

        footer {
            background: #ffffff;
            border-top: 1px solid #ddd;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        input[type="text"],
        input[type="file"] {
            padding: 10px 14px;
            font-size: 15px;
            border: 1px solid #ccc;
            border-radius: 10px;
            width: 100%;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
        }

        button {
            padding: 10px;
            font-size: 15px;
            border: none;
            border-radius: 10px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .image-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .image-preview img {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 600px) {
            header {
                font-size: 1.25rem;
            }

            .message {
                font-size: 14px;
            }

            footer {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>

<header>ü§ñ Agent IA Multimodal</header>

<div class="chat-container" id="chatHistory"></div>

<footer>
    <input type="text" id="queryInput" placeholder="Posez une question...">
    <input type="file" id="imageInput" accept="image/*">
    <button onclick="askLLM()">üì§ Envoyer</button>

    <input type="text" id="imagePromptInput" placeholder="D√©cris une image √† g√©n√©rer...">
    <button onclick="generateImage()">üé® G√©n√©rer une Image</button>
    <div class="image-preview" id="generatedImageResult"></div>
</footer>

<script>
    const chatBox = document.getElementById("chatHistory");

    function appendMessage(content, sender) {
        const row = document.createElement("div");
        row.classList.add("message-row");

        const avatar = document.createElement("img");
        avatar.classList.add("avatar");
        avatar.src = sender === "user"
            ? "https://cdn-icons-png.flaticon.com/512/1077/1077012.png"
            : "https://cdn-icons-png.flaticon.com/512/4712/4712100.png";

        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", sender);
        messageDiv.textContent = content;

        if (sender === "user") {
            row.appendChild(messageDiv);
            row.appendChild(avatar);
        } else {
            row.appendChild(avatar);
            row.appendChild(messageDiv);
        }

        chatBox.appendChild(row);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function askLLM() {
        const queryInput = document.getElementById("queryInput");
        const imageInput = document.getElementById("imageInput");
        const question = queryInput.value.trim();
        const file = imageInput.files[0];

        if (!question) return;

        appendMessage(question, "user");
        queryInput.value = "";
        imageInput.value = "";

        if (file) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("question", question);

            fetch("/askImage", { method: "POST", body: formData })
                .then(r => r.text())
                .then(d => appendMessage(d, "ai"))
                .catch(() => appendMessage("‚ùå Erreur avec l'image.", "ai"));
        } else {
            fetch(`/chat?query=${encodeURIComponent(question)}`)
                .then(r => r.text())
                .then(d => appendMessage(d, "ai"))
                .catch(() => appendMessage("‚ùå Erreur avec le serveur.", "ai"));
        }
    }

    function generateImage() {
        const promptInput = document.getElementById("imagePromptInput");
        const prompt = promptInput.value.trim();
        const resultDiv = document.getElementById("generatedImageResult");

        if (!prompt) {
            resultDiv.innerText = "‚ö†Ô∏è Veuillez saisir un prompt.";
            return;
        }

        appendMessage(`[G√âN√âRATION] ${prompt}`, "user");
        resultDiv.innerHTML = `<p>‚è≥ G√©n√©ration de l'image...</p>`;
        promptInput.value = "";

        fetch(`/generateImage?promt=${encodeURIComponent(prompt)}`)
            .then(r => r.text())
            .then(url => {
                appendMessage("üñºÔ∏è Image g√©n√©r√©e :", "ai");

                const img = document.createElement("img");
                img.src = url;
                img.alt = "Image g√©n√©r√©e";
                img.style.maxWidth = "100%";
                chatBox.appendChild(img);
                chatBox.scrollTop = chatBox.scrollHeight;

                resultDiv.innerHTML = `
            <img src="${url}" alt="Image g√©n√©r√©e">
            <p><a href="${url}" target="_blank">üîó Voir en grand</a></p>`;
            })
            .catch(() => {
                resultDiv.innerText = "‚ùå Erreur lors de la g√©n√©ration de l'image.";
                appendMessage("Erreur lors de la g√©n√©ration.", "ai");
            });
    }
</script>
</body>
</html>
